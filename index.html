<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Statement to Excel Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .upload-section {
            padding: 40px;
            text-align: center;
        }
        
        .upload-box {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 60px 40px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }
        
        .upload-box:hover {
            border-color: #2980b9;
            background: #e3f2fd;
        }
        
        .upload-box.dragover {
            border-color: #27ae60;
            background: #e8f5e8;
        }
        
        .upload-icon {
            font-size: 4em;
            color: #3498db;
            margin-bottom: 20px;
        }
        
        .upload-text {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-subtext {
            color: #7f8c8d;
        }
        
        #fileInput {
            display: none;
        }
        
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.processing {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            padding: 40px;
            display: none;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .summary-item h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        .summary-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn.success {
            background: #27ae60;
        }
        
        .btn.success:hover {
            background: #229954;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .amount {
            text-align: right;
            font-weight: 600;
        }
        
        .balance {
            text-align: right;
            font-weight: bold;
        }
        
        .debug {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9em;
            display: none;
        }
        
        @media (max-width: 768px) {
            .upload-box {
                padding: 40px 20px;
            }
            
            .btn {
                display: block;
                margin: 10px auto;
                width: 200px;
            }
            
            table {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Bank Statement Converter</h1>
            <p>Convert PDF bank statements to Excel format</p>
        </div>
        
        <div class="upload-section">
            <div class="upload-box" onclick="document.getElementById('fileInput').click()" 
                 ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Click here or drag your PDF file</div>
                <div class="upload-subtext">Bank statement PDF files only</div>
                <input type="file" id="fileInput" accept=".pdf" onchange="handleFileSelect(event)">
            </div>
            
            <div id="status" class="status"></div>
            <div id="debug" class="debug"></div>
            
            <button onclick="testMode()" style="background: #f39c12; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                Test with Sample Data
            </button>
        </div>
        
        <div id="results" class="results">
            <div class="summary">
                <div class="summary-item">
                    <h3>Total Transactions</h3>
                    <div class="summary-value" id="totalCount">0</div>
                </div>
                <div class="summary-item">
                    <h3>Beginning Balance</h3>
                    <div class="summary-value" id="beginBalance">0</div>
                </div>
                <div class="summary-item">
                    <h3>Ending Balance</h3>
                    <div class="summary-value" id="endBalance">0</div>
                </div>
                <div class="summary-item">
                    <h3>Net Change</h3>
                    <div class="summary-value" id="netChange">0</div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" onclick="downloadCSV()">üìä Download CSV</button>
                <button class="btn success" onclick="copyToClipboard()">üìã Copy to Clipboard</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Balance</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody id="transactionTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        let transactions = [];
        let debugMode = false;

        function log(message) {
            console.log(message);
            if (debugMode) {
                const debug = document.getElementById('debug');
                debug.style.display = 'block';
                debug.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            }
        }

        function showStatus(message, type = 'processing') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'processing') {
                status.innerHTML = '<div class="spinner"></div>' + message;
            } else {
                status.innerHTML = message;
            }
            
            log(`Status: ${type} - ${message}`);
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        // File handling
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        async function processFile(file) {
            log(`Processing file: ${file.name} (${file.type})`);
            
            if (file.type !== 'application/pdf') {
                showStatus('Please select a PDF file.', 'error');
                return;
            }

            showStatus('Loading PDF processing library...');
            
            try {
                // Load PDF.js dynamically
                await loadPDFJS();
                showStatus('Reading PDF content...');
                
                // Convert file to array buffer
                const arrayBuffer = await file.arrayBuffer();
                log(`File size: ${arrayBuffer.byteLength} bytes`);
                
                // Load PDF
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                log(`PDF loaded. Pages: ${pdf.numPages}`);
                
                showStatus(`Extracting text from ${pdf.numPages} pages...`);
                
                // Extract text from all pages
                let fullText = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                    log(`Page ${i}: ${pageText.length} characters`);
                }
                
                log(`Total text extracted: ${fullText.length} characters`);
                showStatus('Parsing transactions...');
                
                // Parse transactions
                transactions = parseTransactions(fullText);
                log(`Found ${transactions.length} transactions`);
                
                if (transactions.length > 0) {
                    showStatus(`Successfully processed ${transactions.length} transactions!`, 'success');
                    displayResults();
                } else {
                    showStatus('No transactions found. This might not be a supported bank statement format.', 'error');
                    debugMode = true;
                    log('Sample text: ' + fullText.substring(0, 1000));
                }
                
            } catch (error) {
                log(`Error: ${error.message}`);
                showStatus(`Error processing PDF: ${error.message}`, 'error');
            }
        }

        function loadPDFJS() {
            return new Promise((resolve, reject) => {
                if (typeof pdfjsLib !== 'undefined') {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = () => {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    log('PDF.js loaded successfully');
                    resolve();
                };
                script.onerror = () => reject(new Error('Failed to load PDF.js'));
                document.head.appendChild(script);
            });
        }

        function parseTransactions(text) {
            const transactions = [];
            log('Starting transaction parsing...');
            
            // Look for common transaction patterns
            const patterns = [
                // DD/MM DESCRIPTION AMOUNT BALANCE
                /(\d{1,2}\/\d{1,2})\s+(.+?)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)/g,
                // DD/MM/YY DESCRIPTION AMOUNT BALANCE  
                /(\d{1,2}\/\d{1,2}\/\d{2})\s+(.+?)\s+([\d,]+\.?\d*)\s+([\d,]+\.?\d*)/g
            ];
            
            let matchCount = 0;
            
            for (let pattern of patterns) {
                let match;
                while ((match = pattern.exec(text)) !== null) {
                    const [, date, description, amount, balance] = match;
                    
                    // Clean description
                    const cleanDesc = description.trim().replace(/\s+/g, ' ');
                    
                    // Skip invalid entries
                    if (cleanDesc.length < 3 || /^\d+$/.test(cleanDesc)) continue;
                    
                    // Determine transaction type
                    let type = 'Credit';
                    let amountValue = amount;
                    
                    if (cleanDesc.toLowerCase().includes('debit') || 
                        cleanDesc.toLowerCase().includes('withdrawal') ||
                        cleanDesc.toLowerCase().includes('fee') ||
                        cleanDesc.toLowerCase().includes('charge')) {
                        type = 'Debit';
                        amountValue = '-' + amount;
                    }
                    
                    transactions.push({
                        date: date,
                        description: cleanDesc,
                        amount: amountValue,
                        balance: balance,
                        type: type
                    });
                    
                    matchCount++;
                }
                
                log(`Pattern found ${matchCount} matches`);
                if (matchCount > 0) break; // Use first pattern that works
            }
            
            // Remove duplicates
            const unique = transactions.filter((trans, index, self) => 
                index === self.findIndex(t => 
                    t.date === trans.date && t.amount === trans.amount && t.balance === trans.balance
                )
            );
            
            log(`After deduplication: ${unique.length} transactions`);
            return unique;
        }

        function displayResults() {
            // Calculate summary
            const totalCount = transactions.length;
            const beginBalance = transactions.length > 0 ? transactions[0].balance : '0';
            const endBalance = transactions.length > 0 ? transactions[transactions.length - 1].balance : '0';
            
            let credits = 0, debits = 0;
            transactions.forEach(t => {
                const amount = parseFloat(t.amount.replace(/[,\-]/g, ''));
                if (t.type === 'Credit') credits += amount;
                else debits += amount;
            });
            
            const netChange = credits - debits;
            
            // Update summary
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('beginBalance').textContent = beginBalance;
            document.getElementById('endBalance').textContent = endBalance;
            document.getElementById('netChange').textContent = netChange.toFixed(2);
            
            // Populate table
            const tbody = document.getElementById('transactionTable');
            tbody.innerHTML = '';
            
            transactions.forEach(transaction => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td>${transaction.description}</td>
                    <td class="amount">${transaction.amount}</td>
                    <td class="balance">${transaction.balance}</td>
                    <td>${transaction.type}</td>
                `;
            });
            
            // Show results
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function downloadCSV() {
            if (transactions.length === 0) return;
            
            const headers = ['Date', 'Description', 'Amount', 'Balance', 'Type'];
            const csvContent = [
                headers.join(','),
                ...transactions.map(t => [
                    `"${t.date}"`,
                    `"${t.description.replace(/"/g, '""')}"`,
                    `"${t.amount}"`,
                    `"${t.balance}"`,
                    `"${t.type}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bank_statement.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            if (transactions.length === 0) return;
            
            const headers = ['Date', 'Description', 'Amount', 'Balance', 'Type'];
            const text = [
                headers.join('\t'),
                ...transactions.map(t => [t.date, t.description, t.amount, t.balance, t.type].join('\t'))
            ].join('\n');
            
            navigator.clipboard.writeText(text).then(() => {
                showStatus('Copied to clipboard!', 'success');
                setTimeout(hideStatus, 2000);
            });
        }

        function testMode() {
            // Sample data for testing
            transactions = [
                { date: '01/01', description: 'Sample Credit Transaction', amount: '1000.00', balance: '5000.00', type: 'Credit' },
                { date: '02/01', description: 'Sample Debit Transaction', amount: '-500.00', balance: '4500.00', type: 'Debit' },
                { date: '03/01', description: 'Another Credit', amount: '250.00', balance: '4750.00', type: 'Credit' }
            ];
            
            showStatus('Test data loaded!', 'success');
            displayResults();
        }
    </script>
</body>
</html>
